# Техническое задание (ТЗ)

**Проект:** «Универсальный контент-завод» (v1)  
**Дата:** 2026-01-21  
**Версия:** 1.0

## 1) Цель системы
Система автоматически производит и публикует контент (текст + изображения + видео), собирает метрики и самообучается отдельно по каждому проекту. Управление осуществляется через веб-админку.

## 2) Термины
- **Проект** — отдельный бренд/клиент/направление с собственными правилами, источниками, обучением и бюджетами.
- **Источник** — документ/ссылка/заметка/аудио/видео, из которого извлекаются знания.
- **Атом смысла** — структурированный факт/тезис/история/оффер/возражение с привязкой к источнику.
- **Тема** — единица планирования.
- **Контент-единица** — конкретный артефакт для канала (пост, лонгрид, сторис-тезисы, сценарий, видео, обложка и т.д.).
- **Контент-пакет** — набор контент-единиц, произведённых из одной темы.
- **Guardrails** — непереступаемые ограничения (запреты, юридические рамки, бюджеты, лимиты автоизменений).
- **QC** — контроль качества (автоматический слой проверки перед публикацией).

## 3) Обязательные каналы/форматы (MVP)
### 3.1 Каналы (автопостинг «с первого дня»)
- **Telegram (канал/группа)** — публикация через Bot API (или иной доступный API-метод по выбранной реализации).
- **VK (группа/страница)** — публикация через VK API.

### 3.2 Форматы (с первого дня)
- **Текст:** Telegram-посты, VK-посты, лонгрид (экспортируемый формат для сайта/блога).
- **Визуал:** обложки, одиночные изображения, карусели (серии изображений).
- **Видео:** короткие клипы + сборка ролика; генерация через Sora 2.

## 4) Ключевые требования пользователя (зафиксированы)
- Автопостинг реализуется сразу, без полу-ручного режима.
- Аналитика и обучение/оптимизация происходят автоматически, без участия администратора.
- Генерация видео (Sora 2) предусмотрена и включена в MVP.
- Обучение комплекса должно быть независимым для каждого проекта (изоляция данных/настроек/обучающих сигналов).
- Управление системой — через веб-админку.

## 5) Функциональные требования
### 5.1 Веб-админка (обязательно)
**Разделы:**

A) **Проекты**
- Создание/удаление/архивирование проектов.
- Настройка Brand Config: тон, ЦА, офферы, рубрики, запреты, CTA-политика.
- Подключение интеграций и хранение токенов (TG/VK/другие).
- Бюджеты: дневной/недельный/месячный; лимиты генераций (токены/видео-секунды/публикации).

B) **Источники и база знаний**
- Добавление источников: загрузка файлов, добавление ссылок, вставка текста, загрузка аудио/видео.
- Автопарсинг источников, извлечение атомов смысла, индексация (RAG).
- Просмотр источников, связанных атомов, статуса актуальности, версий.

C) **Контент-план**
- Автогенерация тем на период (например 14 дней).
- Рубрики и частотность публикаций.
- Автосоставление расписания публикаций.

D) **Производство**
- Запуск генерации контент-пакетов по темам.
- Мониторинг статусов пайплайна (queued/running/failed/done).
- Просмотр результатов (тексты, визуалы, видео, метаданные).

E) **Публикации**
- Календарь автопостинга.
- Журнал публикаций: platform_post_id, ссылки, версия контента, время.

F) **Видео-цех**
- Сценарий/сториборд, клипы, сборка ролика, превью, статус генерации.
- Очереди на генерацию, ретраи, хранение результатов.

G) **Аналитика и обучение**
- Дашборды метрик (по проекту/каналу/рубрике/формату/теме).
- Лог автоизменений (какие параметры изменены и почему).
- Откат (rollback) на любую стабильную версию правил/промптов/настроек.

H) **Логи и мониторинг**
- Логи задач и ошибок интеграций.
- Алерты по падениям публикации/сбору метрик/превышению бюджета.
- Отчёт расходов по проектам.

**Роли доступа:**
- **Admin** — полный доступ (включая токены, бюджеты, роли пользователей).
- **Editor** — доступ к контенту/плану/публикациям без управления секретами и бюджетами.
- **Viewer** — только просмотр.

### 5.2 Пайплайн контент-производства (автоматический)
Пайплайн одинаков для всех проектов, но управляется конфигом каждого проекта.

A) **Ingest (Источники → база знаний)**
- STT для аудио.
- LLM-экстрактор: выделение атомов смысла (факты, тезисы, истории, офферы, возражения).
- Embeddings + запись в векторное хранилище проекта.
- Для каждого атома: обязательная ссылка на источник + метаданные (дата, тип, доверие/приоритет).

B) **Planner (Планирование)**
- Генерация тем, углов подачи, подбор рубрик.
- Формирование контент-пакетов.
- Автосоставление расписания публикаций.

C) **Producer (Генерация)**
- Генерация текстов под каналы (TG/VK/лонгрид) в соответствии с Brand Config.
- Генерация промптов под изображения.
- Генерация сценариев/раскадровок под видео.
- Генерация метаданных: CTA, хэштеги, alt-текст, ключевые тезисы.

D) **QC (Авто-контроль качества)**
- Проверка на соответствие voice/тональности проекта.
- Проверка фактов через RAG: каждый факт помечается как source_backed=true/false.
- Проверка рисков: запреты, обещания “100%”, чувствительные темы, токсичность/клевета.
- Анти-повторы/анти-шаблонность.
- Читабельность: структура, абзацы, “хук”, логика.
- Итоговый скоринг + причины (QC-репорт).

E) **Publisher (Автопостинг)**
- Публикация по расписанию без участия администратора.
- Ретраи, дедупликация, идемпотентность публикаций.
- Сохранение platform_post_id, времени публикации, ссылки, связанных метрик.

### 5.3 Видео-цех (Sora 2) — обязательно в MVP
**Процесс видео:**
1) На входе: тема/задача → создаётся сценарий и сториборд.
2) Автоматическое разбиение на клипы (4/8/12 сек или иной доступный формат).
3) Генерация клипов через Sora 2 с едиными “якорями стиля”:
   - камера/тип движения/ракурс
   - персонажи/персистентные атрибуты (если используются)
   - свет/палитра/локация
4) Пост-процессинг:
   - склейка клипов (ffmpeg)
   - нормализация (разрешение/кодек)
   - опционально: удаление/приглушение аудио
   - генерация обложки/титров (опционально)
5) Публикация видео в каналы (как видео или как ссылка на хостинг — определяется конфигом проекта).

**Требования к стабильности видео:**
- Единый стиль и визуальная консистентность в пределах ролика.
- Отсутствие “скачков” сюжетной логики на стыках клипов (за счёт якорей и сториборда).
- Ретраи при неуспешной генерации.
- Лимитирование расходов (видео-секунды) по бюджету проекта.

### 5.4 Автоматическая аналитика и самообучение (без админа)
**Сбор метрик:**
- Метрики площадок (где доступно через API).
- Обязательный слой click-tracking (редирект-сервис с учётом UTM), чтобы собирать клики независимо от площадки.

**Автообучение (внутри проекта):**
- Оптимизация расписания (слоты публикаций).
- Оптимизация углов подачи и CTA (multi-armed bandit / эвристики).
- Обновление “правил генерации” (весов шаблонов, параметров промптов) на основе лучших перформеров.
- Пополнение пула тем из комментариев/вопросов аудитории (если подключено).

**Guardrails для автообучения:**
- Нельзя автоматически менять: юридические дисклеймеры, запретные темы, критические табу тона/лексики, запрещённые обещания.
- Ограничение скорости изменений (не более N правок/неделю, параметризуется проектом).
- Авто-rollback: если показатели падают ниже порога X на окне Y публикаций — откат на последнюю стабильную версию.
- Бюджетные лимиты: при превышении — приостановка генераций/видео и публикаций до следующего окна.

### 5.5 Независимость обучения по проектам (изоляция)
Система обязана обеспечивать:
- отдельные векторные базы, датасеты, версии промптов, шаблоны, расписания, метрики, бюджеты для каждого проекта;
- недопустимость “перетекания” данных и обучающих сигналов между проектами;
- любое автоизменение применяется только в рамках одного проекта.

**Опциональный слой “глубокого обучения” (переключаемый флагом проекта):**
- формирование датасета и запуск fine-tuning/предпочтений/укрепляющего обучения, если это предусмотрено стратегией проекта и бюджетом;
- полное логирование обучающих запусков и версий моделей/параметров.

## 6) Нефункциональные требования
- Надёжность: очередь задач, ретраи, дедупликация, идемпотентность публикаций, восстановление после падений.
- Наблюдаемость: логи, трассировка, алерты, отчёт по расходам.
- Безопасность: секреты в защищённом хранилище, ротация, разграничение прав, аудит действий.
- Стоимость: hard-cap бюджета на проект/день; автоматическая защита от перерасхода.
- Версионность и воспроизводимость: версии промптов, конфигов, результатов генераций, причин QC и обучающих событий.

## 7) Минимальная модель данных (MVP)
- projects
- brand_configs (versioned)
- sources
- atoms
- topics
- content_packs
- content_items
- qc_reports
- publications
- metrics_snapshots
- learning_events (что изменили и почему)
- prompt_versions
- budgets & usage (токены/видео-секунды/операции)

## 8) Архитектура и компоненты (рекомендованный стек)
- Backend: Python + FastAPI
- Очереди: Redis + Celery/Arq (или аналог)
- DB: Postgres
- Object storage: S3-совместимое (видео/изображения/файлы)
- Vector store: pgvector (или отдельный сервис)
- Web-admin: SPA (React/Next.js) + API

## 9) Критерии приёмки (Acceptance Criteria)
1) Админка позволяет:
   - создать проект,
   - задать Brand Config,
   - подключить TG и VK,
   - выставить бюджеты,
   - запустить автопроизводство и автопостинг.

2) Из 1 темы система автоматически:
   - создаёт контент-пакет (лонгрид + 5 TG + 3 VK + визуалы + сценарий видео),
   - публикует все материалы согласно расписанию без участия админа,
   - сохраняет идентификаторы публикаций.

3) Видео:
   - система генерирует клипы через Sora 2,
   - собирает финальный ролик,
   - публикует/передаёт в публикационный модуль, хранит артефакты.

4) QC:
   - ни одна единица не публикуется без статуса QC=pass,
   - для всех фактов есть пометка source_backed true/false.

5) Метрики и автообучение:
   - клики по ссылкам собираются всегда (через редирект-сервис),
   - по итогам N публикаций система автоматически меняет минимум 1 параметр (слот времени/угол/CTA/шаблон),
   - каждое автоизменение фиксируется в learning_events.

6) Изоляция:
   - данные и обучение проектов полностью раздельны (проверяется на тестовом стенде).
